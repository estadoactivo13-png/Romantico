<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C치psula de Amor - Vista Previa</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Poppins:wght@300;600&display=swap" rel="stylesheet">
    <style>
        :root { --oro: #d4af37; --blanco: #ffffff; --sombra: rgba(0, 0, 0, 0.7); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #000; }
        
        .bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), 
                        url('https://images.unsplash.com/photo-1518199266791-5375a83190b7?q=80&w=2000') no-repeat center center;
            background-size: cover; z-index: -1;
        }

        .dedicatoria-top {
            position: absolute; top: 40px; left: 40px; text-align: left;
            border-left: 4px solid var(--oro); padding-left: 20px;
            text-shadow: 2px 2px 8px var(--sombra); color: white;
        }

        .dedicatoria-top span { display: block; font-family: 'Playfair Display', serif; font-size: 1.6rem; color: var(--oro); }

        .container { text-align: center; color: var(--blanco); width: 90%; }
        h1 { font-family: 'Playfair Display', serif; font-size: 2.8rem; text-shadow: 3px 3px 10px var(--sombra); margin-bottom: 10px; }

        #btnAbrir {
            display: none; font-size: 5rem; cursor: pointer;
            filter: drop-shadow(0 0 15px var(--oro));
            animation: pulse 2s infinite; background: none; border: none; margin-top: 20px;
        }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            z-index: 100; align-items: center; justify-content: center;
        }

        .modal-content {
            background: #fff; color: #333; padding: 40px; border-radius: 25px;
            width: 85%; max-width: 500px; text-align: center;
            border: 6px double var(--oro); position: relative;
        }

        .modal-content p { font-size: 1.2rem; line-height: 1.8; color: #444; font-style: italic; }
        .close { position: absolute; top: 15px; right: 20px; font-size: 30px; cursor: pointer; color: #aaa; }
    </style>
</head>
<body>

    <div class="bg-overlay"></div>

    <div class="dedicatoria-top">
        <p>PARA: <span id="txtPara">...</span></p>
        <p>DE: <span id="txtDe">...</span></p>
    </div>

    <div class="container">
        <h1 id="tituloMain">Cargando sorpresa...</h1>
        <button id="btnAbrir" onclick="abrirCaja()">游눏</button>
    </div>

    <div id="miModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarCaja()">&times;</span>
            <h2 style="font-family: 'Playfair Display'; color: var(--oro); margin-bottom: 20px;">Nuestra Historia</h2>
            <p id="txtMensaje"></p>
        </div>
    </div>

    <audio id="musica" loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <script>
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTX9GbZ-VpQB2QgB8pkkwy4YvgN6qIqDSwvgTUmqyAVwGFqwEEK3fIPjxd09QxJtEuRXRzowvjCIEjo/pub?output=csv';

        async function cargarDatos() {
            const params = new URLSearchParams(window.location.search);
            const idBuscado = params.get('id');

            if (!idBuscado) {
                document.getElementById('tituloMain').innerText = "Por favor, escanea un c칩digo v치lido";
                return;
            }

            try {
                const response = await fetch(csvUrl);
                const csvData = await response.text();
                
                // Dividir filas correctamente manejando posibles saltos de l칤nea dentro de mensajes
                const filas = csvData.split(/\r?\n/).map(row => row.split(','));

                // Buscamos en la columna 1 (ID)
                const fila = filas.find(f => f[1] && f[1].trim() === idBuscado.trim());

                if (fila) {
                    document.getElementById('tituloMain').innerText = "Un regalo para ti";
                    document.getElementById('txtPara').innerText = fila[2] || "Alguien Especial";
                    document.getElementById('txtDe').innerText = fila[3] || "Tu admirador";
                    
                    const mensaje = fila[4];
                    if (mensaje && mensaje.trim().length > 1) {
                        document.getElementById('txtMensaje').innerText = mensaje.replace(/"/g, '');
                        document.getElementById('btnAbrir').style.display = 'inline-block';
                    } else {
                        // Si no hay mensaje, la m칰sica se activa al tocar la pantalla
                        document.body.onclick = () => document.getElementById('musica').play();
                        document.getElementById('tituloMain').innerText = "Escucha nuestra canci칩n";
                    }
                } else {
                    document.getElementById('tituloMain').innerText = "ID no encontrado o a칰n no configurado";
                }
            } catch (e) {
                document.getElementById('tituloMain').innerText = "Error de conexi칩n";
            }
        }

        function abrirCaja() {
            document.getElementById('miModal').style.display = 'flex';
            document.getElementById('musica').play().catch(() => console.log("Click requerido para audio"));
        }

        function cerrarCaja() { document.getElementById('miModal').style.display = 'none'; }

        window.onload = cargarDatos;
    </script>
</body>
</html>